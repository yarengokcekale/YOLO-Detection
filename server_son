import cv2
from ultralytics import YOLO
import pygame
import tkinter as tk
from tkinter import ttk
from datetime import datetime
from PIL import Image, ImageTk
import numpy as np
import socket
import threading
import json
import time
import pandas as pd
from tkinter import filedialog, messagebox

# Model ve ses dosyasÄ± yollarÄ±
model_path = r"C:\Users\yaren\OneDrive\MasaÃ¼stÃ¼\drone_dataset\runs\detect\train\weights\best.pt"
sound_path = r"C:\Users\yaren\OneDrive\MasaÃ¼stÃ¼\drone_dataset\alert.wav"

# Modeli yÃ¼kle
model = YOLO(model_path)

# Pygame ses sistemi baÅŸlat
pygame.init()
pygame.mixer.init()
pygame.mixer.music.load(sound_path)

# TCP Server ayarlarÄ±
SERVER_HOST = '127.0.0.1'  # localhost
SERVER_PORT = 8888
connected_clients = []

# Global deÄŸiÅŸkenler - Client ile uyumlu format
current_drone_data = {
    "drone_count": 0,
    "threat_level": "YOK",  # Client formatÄ±: YOK, DUSUK, ORTA SEVÄ°YE, YUKSEK TEHLÄ°KE
    "detections": [],
    "timestamp": "",
    "fire_authorized": False
}

# Raporlar iÃ§in geÃ§miÅŸ veriler - Client formatÄ±na uygun
detection_history = []
max_history = 1000  # Son 1000 tespiti sakla

def play_alert():
    if not pygame.mixer.music.get_busy():
        pygame.mixer.music.play()

def start_server():
    """TCP sunucusunu baÅŸlat"""
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socket.bind((SERVER_HOST, SERVER_PORT))
    server_socket.listen(5) 
    
    # listen(5) sunucu aynÄ± anda en fazla 5 baÄŸlantÄ± isteÄŸini kuyruÄŸa alabilir.
    #Bu sayÄ± aÅŸÄ±ldÄ±ÄŸÄ±nda, yeni baÄŸlantÄ± istekleri reddedilebilir veya zaman aÅŸÄ±mÄ±na uÄŸrayabilir.
    print(f"Sunucu {SERVER_HOST}:{SERVER_PORT} adresinde baÅŸlatÄ±ldÄ±...")
    
    def handle_client(client_socket, client_address):
        """Ä°stemci baÄŸlantÄ±larÄ±nÄ± yÃ¶net"""
        print(f"Yeni baÄŸlantÄ±: {client_address}")
        connected_clients.append(client_socket)
        
        try:
            while True:
                # Ä°stemciden veri bekle (ateÅŸ emri vs.)
                try:
                    data = client_socket.recv(1024).decode('utf-8')
                    if data:
                        message = json.loads(data)
                        if message.get("command") == "FIRE":
                            print(f"ATEÅ EMRÄ° alÄ±ndÄ± - Ä°stemci: {client_address}")
                            # Burada gerÃ§ek ateÅŸ etme iÅŸlemi yapÄ±labilir
                            
                except socket.timeout:
                    continue
                except:
                    break
                    
        except Exception as e:
            print(f"Ä°stemci hatasÄ± {client_address}: {e}")
        finally:
            if client_socket in connected_clients:
                connected_clients.remove(client_socket)
            client_socket.close()
            print(f"BaÄŸlantÄ± kesildi: {client_address}")
    
    def accept_connections():
        """Yeni baÄŸlantÄ±larÄ± kabul et"""
        while True:
            try:
                client_socket, client_address = server_socket.accept()
                client_socket.settimeout(1.0)  # Timeout ayarla
                client_thread = threading.Thread(
                    target=handle_client, 
                    args=(client_socket, client_address)
                )
                client_thread.daemon = True
                client_thread.start()
            except Exception as e:
                print(f"Sunucu hatasÄ±: {e}")
                break
    
    # BaÄŸlantÄ± kabul etme thread'ini baÅŸlat
    accept_thread = threading.Thread(target=accept_connections)
    accept_thread.daemon = True
    accept_thread.start()

def broadcast_drone_data():
    """Drone verilerini tÃ¼m istemcilere gÃ¶nder"""
    if not connected_clients:
        return
    # connected_clients (baÄŸlÄ± istemcilerin listesi) deÄŸiÅŸkeninin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± kontrol eder.
    # EÄŸer liste boÅŸsa, yani hiÃ§bir istemci baÄŸlÄ± deÄŸilse, veriyi gÃ¶ndermenin bir anlamÄ± yoktur.   
    message = json.dumps(current_drone_data) + "\n"
    #json.dumps(current_drone_data): Python sÃ¶zlÃ¼ÄŸÃ¼ olan current_drone_data'yÄ± JSON formatÄ±nda bir string'e dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r
    
    for client in connected_clients[:]:  # Kopya liste kullan
        try:
            client.send(message.encode('utf-8'))
        except Exception as e:
            print(f"Ä°stemciye veri gÃ¶nderme hatasÄ±: {e}")
            if client in connected_clients:
                connected_clients.remove(client)

# Tkinter SCADA arayÃ¼zÃ¼ oluÅŸtur
window = tk.Tk()
window.title("Drone Tespit Server - Raporlar")
window.geometry("1400x900")

# Ana Ã§erÃ§eve
main_frame = tk.Frame(window)
main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

# Ãœst kÄ±sÄ±m - Sistem Durumu
status_frame = tk.LabelFrame(main_frame, text="Sistem Durumu", font=("Arial", 14, "bold"), height=120)
status_frame.pack(fill=tk.X, pady=(0, 10))
status_frame.pack_propagate(False)

# Durum bilgileri iÃ§in grid layout
status_grid = tk.Frame(status_frame)
status_grid.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

# Sol kolon - Server bilgileri
left_status = tk.Frame(status_grid)
left_status.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

server_label = tk.Label(left_status, text=f"Server: {SERVER_HOST}:{SERVER_PORT}", 
                       font=("Arial", 11, "bold"), fg="blue")
server_label.pack(anchor="w")

client_count_label = tk.Label(left_status, text="BaÄŸlÄ± Ä°stemci: 0", font=("Arial", 11))
client_count_label.pack(anchor="w")

system_time_label = tk.Label(left_status, text="", font=("Arial", 11))
system_time_label.pack(anchor="w")

# Orta kolon - Tespit durumu
middle_status = tk.Frame(status_grid)
middle_status.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=20)

threat_level_label = tk.Label(middle_status, text="Tehlike Seviyesi: YOK", 
                             font=("Arial", 12, "bold"), fg="green")
threat_level_label.pack(anchor="w")

active_drones_label = tk.Label(middle_status, text="Aktif Drone: 0", font=("Arial", 11))
active_drones_label.pack(anchor="w")

last_detection_label = tk.Label(middle_status, text="Son Tespit: -", font=("Arial", 11))
last_detection_label.pack(anchor="w")

# SaÄŸ kolon - Sistem kontrolleri
right_status = tk.Frame(status_grid)
right_status.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)

camera_status_label = tk.Label(right_status, text="Kamera: Aktif", 
                              font=("Arial", 11), fg="green")
camera_status_label.pack(anchor="w")

ai_model_label = tk.Label(right_status, text="AI Model: YÃ¼klÃ¼", 
                         font=("Arial", 11), fg="green")
ai_model_label.pack(anchor="w")

alert_system_label = tk.Label(right_status, text="Alarm Sistemi: HazÄ±r", 
                             font=("Arial", 11), fg="green")
alert_system_label.pack(anchor="w")

# Ana iÃ§erik alanÄ± - Notebook iÃ§in
content_frame = tk.Frame(main_frame)
content_frame.pack(fill=tk.BOTH, expand=True)

# Notebook (sekmeli arayÃ¼z)
notebook = ttk.Notebook(content_frame)
notebook.pack(fill=tk.BOTH, expand=True)

# Sekme 1: AnlÄ±k Tespitler
current_frame = tk.Frame(notebook)
notebook.add(current_frame, text="AnlÄ±k Tespitler")

# AnlÄ±k tespitler iÃ§in treeview - Client ile uyumlu sÃ¼tunlar
current_tree_frame = tk.Frame(current_frame)
current_tree_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

current_tree_scroll = tk.Scrollbar(current_tree_frame)
current_tree_scroll.pack(side=tk.RIGHT, fill=tk.Y)

current_tree = ttk.Treeview(current_tree_frame, 
                           columns=("ID", "Tehlike Seviyesi", "GÃ¼ven", "BÃ¶lge", "X Ekseni", "Y Ekseni"),
                           show="headings",
                           yscrollcommand=current_tree_scroll.set)

current_tree_scroll.config(command=current_tree.yview)

# SÃ¼tun baÅŸlÄ±klarÄ± ve geniÅŸlikleri - Client ile aynÄ± format
columns_config = [
    ("ID", 80),
    ("Tehlike Seviyesi", 120),
    ("GÃ¼ven", 100),
    ("BÃ¶lge", 120),
    ("X Ekseni", 100),
    ("Y Ekseni", 100)
]

for col, width in columns_config:
    current_tree.heading(col, text=col)
    current_tree.column(col, width=width, anchor="center")

current_tree.pack(fill=tk.BOTH, expand=True)

# Sekme 2: Tespit GeÃ§miÅŸi
history_frame = tk.Frame(notebook)
notebook.add(history_frame, text="Tespit GeÃ§miÅŸi")

# GeÃ§miÅŸ iÃ§in kontroller
history_controls = tk.Frame(history_frame)
history_controls.pack(fill=tk.X, padx=10, pady=5)

clear_history_btn = tk.Button(history_controls, text="GeÃ§miÅŸi Temizle", 
                             command=lambda: clear_detection_history())
clear_history_btn.pack(side=tk.LEFT)

export_excel_btn = tk.Button(history_controls, text="Excel'e Aktar", 
                            command=lambda: export_to_excel())
export_excel_btn.pack(side=tk.LEFT, padx=(10, 0))

export_txt_btn = tk.Button(history_controls, text="TXT'ye Aktar", 
                          command=lambda: export_to_txt())
export_txt_btn.pack(side=tk.LEFT, padx=(10, 0))

# GeÃ§miÅŸ iÃ§in treeview - Client ile aynÄ± format
history_tree_frame = tk.Frame(history_frame)
history_tree_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

history_tree_scroll = tk.Scrollbar(history_tree_frame)
history_tree_scroll.pack(side=tk.RIGHT, fill=tk.Y)

history_tree = ttk.Treeview(history_tree_frame,
                           columns=("Tespit Saati", "ID", "GÃ¼ven", "BÃ¶lge", "Tehlike Seviyesi", "X Ekseni", "Y Ekseni"),
                           show="headings",
                           yscrollcommand=history_tree_scroll.set)

history_tree_scroll.config(command=history_tree.yview)

# GeÃ§miÅŸ tablosu sÃ¼tun yapÄ±landÄ±rmasÄ± - Client ile birebir aynÄ±
history_columns_config = [
    ("Tespit Saati", 180),
    ("ID", 60),
    ("GÃ¼ven", 80),
    ("BÃ¶lge", 120),
    ("Tehlike Seviyesi", 120),
    ("X Ekseni", 70),
    ("Y Ekseni", 70)
]

for col, width in history_columns_config:
    history_tree.heading(col, text=col)
    history_tree.column(col, width=width, anchor="center")

history_tree.pack(fill=tk.BOTH, expand=True)

# Sekme 3: Ä°statistikler
stats_frame = tk.Frame(notebook)
notebook.add(stats_frame, text="Ä°statistikler")

# Ä°statistik gÃ¶stergeleri
stats_grid = tk.Frame(stats_frame)
stats_grid.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)

# Ä°statistik kartlarÄ±
stat_cards = []
stat_texts = ["Toplam Tespit", "YÃ¼ksek Tehlike", "Orta Seviye", "DÃ¼ÅŸÃ¼k Tehlike", 
              "Ortalama GÃ¼ven", "Aktif SÃ¼re"]

for i in range(6):
    card_frame = tk.LabelFrame(stats_grid, text=stat_texts[i], font=("Arial", 12, "bold"))
    card_frame.grid(row=i//3, column=i%3, padx=10, pady=10, sticky="nsew", ipadx=20, ipady=20)
    
    value_label = tk.Label(card_frame, text="0", font=("Arial", 24, "bold"), fg="blue")
    value_label.pack()
    
    stat_cards.append(value_label)

# Grid aÄŸÄ±rlÄ±klarÄ±nÄ± ayarla
for i in range(2):
    stats_grid.grid_rowconfigure(i, weight=1)
for i in range(3):
    stats_grid.grid_columnconfigure(i, weight=1)

def clear_detection_history():
    """Tespit geÃ§miÅŸini temizle"""
    global detection_history
    detection_history.clear()
    update_history_tree()
    messagebox.showinfo("BaÅŸarÄ±lÄ±", "Tespit geÃ§miÅŸi temizlendi!")

def export_to_excel():
    """Raporu Excel dosyasÄ±na aktar"""
    try:
        if not detection_history:
            messagebox.showwarning("UyarÄ±", "DÄ±ÅŸa aktarÄ±lacak veri bulunmuyor!")
            return
            
        filename = filedialog.asksaveasfilename(
            defaultextension=".xlsx",
            filetypes=[("Excel dosyasÄ±", "*.xlsx"), ("TÃ¼m dosyalar", "*.*")],
            initialfile=f"drone_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        )
        
        if filename:
            # Pandas DataFrame oluÅŸtur
            df = pd.DataFrame(detection_history)
            
            # SÃ¼tun sÄ±ralamasÄ± dÃ¼zenle - Client formatÄ±na uygun
            column_order = ['timestamp', 'id', 'confidence', 'zone', 'threat_level', 'x_coord', 'y_coord']
            df = df[column_order]
            
            # SÃ¼tun adlarÄ±nÄ± TÃ¼rkÃ§e yap - Client ile uyumlu
            df.columns = ['Tespit Saati', 'Drone ID', 'GÃ¼ven OranÄ± (%)', 'BÃ¶lge', 'Tehlike Seviyesi', 'X Ekseni', 'Y Ekseni']
            
            # Excel'e kaydet
            with pd.ExcelWriter(filename, engine='openpyxl') as writer:
                df.to_excel(writer, sheet_name='Drone Tespitleri', index=False)
                
                # Ã‡alÄ±ÅŸma sayfasÄ±nÄ± al ve biÃ§imlendir
                worksheet = writer.sheets['Drone Tespitleri']
                
                # SÃ¼tun geniÅŸliklerini ayarla
                column_widths = [20, 12, 15, 15, 18, 12, 12]
                for i, width in enumerate(column_widths, 1):
                    worksheet.column_dimensions[chr(64+i)].width = width
                
                # BaÅŸlÄ±k satÄ±rÄ±nÄ± kalÄ±nlaÅŸtÄ±r
                for cell in worksheet[1]:
                    cell.font = cell.font.copy(bold=True)
            
            messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Rapor baÅŸarÄ±yla Excel dosyasÄ±na kaydedildi:\n{filename}")
    except Exception as e:
        messagebox.showerror("Hata", f"Excel dosyasÄ± kaydedilirken hata oluÅŸtu:\n{str(e)}")

def export_to_txt():
    """Raporu TXT dosyasÄ±na aktar"""
    try:
        if not detection_history:
            messagebox.showwarning("UyarÄ±", "DÄ±ÅŸa aktarÄ±lacak veri bulunmuyor!")
            return
            
        filename = filedialog.asksaveasfilename(
            defaultextension=".txt",
            filetypes=[("Metin dosyasÄ±", "*.txt"), ("TÃ¼m dosyalar", "*.*")],
            initialfile=f"drone_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        )
        
        if filename:
            with open(filename, 'w', encoding='utf-8') as f:
                f.write("DRONE TESPÄ°T RAPORU\n")
                f.write("="*80 + "\n")
                f.write(f"Rapor Tarihi: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"Toplam Tespit: {len(detection_history)}\n\n")
                
                # Client formatÄ±na uygun baÅŸlÄ±klar
                f.write(f"{'Tespit Saati':<20} {'ID':<8} {'GÃ¼ven':<8} {'BÃ¶lge':<15} {'Tehlike':<15} {'X Eks':<8} {'Y Eks':<8}\n")
                f.write("-" * 95 + "\n")
                
                for detection in detection_history:
                    f.write(f"{detection['timestamp']:<20} ")
                    f.write(f"{detection['id']:<8} ")
                    f.write(f"{detection['confidence']:<8.1f} ")
                    f.write(f"{detection['zone']:<15} ")
                    f.write(f"{detection['threat_level']:<15} ")
                    f.write(f"{detection['x_coord']:<8.2f} ")
                    f.write(f"{detection['y_coord']:<8.2f}\n")
            
            messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Rapor baÅŸarÄ±yla TXT dosyasÄ±na kaydedildi:\n{filename}")
    except Exception as e:
        messagebox.showerror("Hata", f"TXT dosyasÄ± kaydedilirken hata oluÅŸtu:\n{str(e)}")

def get_direction_from_coordinates(x, y):
    """Client ile aynÄ± yÃ¶n hesaplama algoritmasÄ±"""
    tolerance = 0.1 # sayÄ±lar 0.1 artarak gidiyor
    
    # Merkez bÃ¶lge kontrolÃ¼
    if abs(x) <= tolerance and abs(y) <= tolerance:
        return "MERKEZ"
    
    # Ana ve ara yÃ¶nleri belirle
    if abs(x) <= tolerance:  # Dikey eksen Ã¼zerinde
        return "KUZEY" if y > 0 else "GÃœNEY"
    elif abs(y) <= tolerance:  # Yatay eksen Ã¼zerinde
        return "DOÄU" if x > 0 else "BATI"
    else:  # Ara yÃ¶nler
        if x > 0 and y > 0:
            return "KUZEYDOÄU"
        elif x < 0 and y > 0:
            return "KUZEYBATI"
        elif x < 0 and y < 0:
            return "GÃœNEYBATI"
        else:  # x > 0 and y < 0
            return "GÃœNEYDOÄU"

def update_current_tree():
    """AnlÄ±k tespitler tablosunu gÃ¼ncelle - Client formatÄ±na uygun"""
    # Mevcut verileri temizle
    for item in current_tree.get_children():
        current_tree.delete(item)
    
    # Yeni verileri ekle - Client ile aynÄ± format
    for detection in current_drone_data.get("detections", []):
        pos = detection["position"]
        
        # Client ile AYNI koordinat dÃ¶nÃ¼ÅŸÃ¼mÃ¼ - Bu kritik dÃ¼zeltme!
        normalized_x = -((pos.get("map_x", 0.5) * 2) - 1)  # X'i ters Ã§evir
        normalized_y = -((pos.get("map_y", 0.5) * 2) - 1)  # Y'yi ters Ã§evir
        
        # BÃ¶lge adÄ±nÄ± koordinatlardan hesapla
        zone_name = get_direction_from_coordinates(normalized_x, normalized_y)
        
        current_tree.insert("", "end", values=(
            f"D{detection['id']:03d}", #drone Ä±d no belirtirken 001 ÅŸeklinde---DEÄÄ°ÅEBLÄ°R
            current_drone_data.get("threat_level", "YOK"),  # Genel tehlike seviyesi
            f"{detection['confidence']:.1f}%",
            zone_name,
            f"{normalized_x:.2f}",
            f"{normalized_y:.2f}"
        ))

def update_history_tree():
    """GeÃ§miÅŸ tespitler tablosunu gÃ¼ncelle - Client ile birebir aynÄ±"""
    # Mevcut verileri temizle
    for item in history_tree.get_children():
        history_tree.delete(item)
    
    # Son tespitleri ekle (en yeniden eskiye) - Client formatÄ±
    for detection in reversed(detection_history[-100:]):  # Son 100 kayÄ±t
        history_tree.insert("", "end", values=(
            detection["timestamp"],
            detection["id"],
            f"{detection['confidence']:.1f}%",
            detection["zone"],
            detection["threat_level"],
            f"{detection['x_coord']:.2f}",
            f"{detection['y_coord']:.2f}"
        ))

def update_statistics():
    """Ä°statistikleri gÃ¼ncelle - DÃ¼zeltilmiÅŸ tehlike seviyesi sayÄ±mÄ±"""
    total_detections = len(detection_history)
    
    # Client ile uyumlu tehlike seviyesi sayÄ±mÄ±
    high_threat = len([d for d in detection_history if d["threat_level"] == "YUKSEK TEHLÄ°KE"])
    medium_threat = len([d for d in detection_history if d["threat_level"] == "ORTA SEVÄ°YE"])
    low_threat = len([d for d in detection_history if d["threat_level"] in ["DUSUK", "YOK"]])
    
    avg_confidence = 0
    if detection_history:
        avg_confidence = sum(d["confidence"] for d in detection_history) / len(detection_history)
    
    # Aktif sÃ¼re hesaplama (program baÅŸlangÄ±cÄ±ndan itibaren)
    if not hasattr(update_statistics, 'start_time'):
        update_statistics.start_time = datetime.now()
    
    active_time = datetime.now() - update_statistics.start_time
    active_hours = int(active_time.total_seconds() // 3600)
    active_minutes = int((active_time.total_seconds() % 3600) // 60)
    
    # Ä°statistik kartlarÄ±nÄ± gÃ¼ncelle
    stat_values = [
        str(total_detections),
        str(high_threat),
        str(medium_threat),
        str(low_threat),
        f"%{avg_confidence:.1f}",
        f"{active_hours:02d}:{active_minutes:02d}"
    ]
    
    for i, value in enumerate(stat_values):
        stat_cards[i].config(text=value)

# Kamera baÅŸlat (arka planda)
cap = cv2.VideoCapture(0)

def background_detection():
    """Arka planda drone tespiti yap - Koordinat dÃ¼zeltmeli"""
    global current_drone_data, detection_history
    
    ret, frame = cap.read() #OpenCV Ã¼zerinden bir sonraki video karesini okumaya Ã§alÄ±ÅŸÄ±r
    if not ret:
        return

    results = model(frame) #yolo modelinden alÄ±nan frame Ã¼zerinden nesne tespiti yapar
    
    # Client ile uyumlu tehlike seviyeleri
    threat_level = "YOK"
    alert_triggered = False #alarmÄ±n tetiklenip tetiklenmediÄŸini belirtir, baÅŸlangÄ±Ã§ta false
    detections = [] # mevcut karedeki tespit edilen drone larÄ± depolamak iÃ§in boÅŸ bir liste oluÅŸturur.
    # sonrasÄ±nda bu liste current_drone_data iine eklenecektir
    
    frame_height, frame_width = frame.shape[:2] #kameradan okunan frame yÃ¼ksekliÄŸini ve geniÅŸliÄŸini alÄ±r
    # alÄ±nan bu deÄŸerler koordinat normalizasyonnu iÃ§in kullanÄ±lacaktÄ±r.

    for i, result in enumerate(results):
        for j, box in enumerate(result.boxes): #her bir result iÃ§inde tespit edilen bounding box(sÄ±nÄ±rlayÄ±cÄ± kutu) Ã¼zerinde dÃ¶ngÃ¼ yapar
            cls_id = int(box.cls[0].item()) #nesnelerin sÄ±nÄ±f Ä±d si
            cls_name = model.names[cls_id]

            if cls_name.lower() != "drone":
                continue

            x1, y1, x2, y2 = box.xyxy[0].cpu().numpy() #bounding box iÃ§in geniÅŸlik, yÃ¼kseklik ve alan hesabÄ±
            width = x2 - x1
            height = y2 - y1
            area = width * height
            confidence = box.conf[0].item() * 100 #tespit gÃ¼veni 0-1 arasÄ±nda bir deÄŸer alÄ±r, 100 ile Ã§apÄ±larak yÃ¼zdeye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼r.

            center_x = int((x1 + x2) / 2) #bounding box iÃ§in merkez noktasÄ± hesaplama
            center_y = int((y1 + y2) / 2)
            
            # GPS koordinatlarÄ±nÄ± simÃ¼le et
            base_lat = 39.7767  # EskiÅŸehir enlem
            base_lon = 30.5206  # EskiÅŸehir boylam

            lat_offset = ((center_y - frame_height/2) / (frame_height/2)) * 0.01
            lon_offset = ((center_x - frame_width/2) / (frame_width/2)) * 0.01

            drone_lat = base_lat + lat_offset
            drone_lon = base_lon + lon_offset
            
            # KRÄ°TÄ°K DÃœZELTME: Koordinat sistemi client ile tam uyumlu
            # 0-1 aralÄ±ÄŸÄ±nda normalize edilmiÅŸ koordinatlar
            map_x = center_x / frame_width  # 0=sol, 1=saÄŸ (kameradan bakÄ±ÅŸ)
            # drone merkezinin x koordinatÄ±nÄ±, Ã§erÃ§eve geniÅŸliÄŸine oranlayarak 0-1 arasÄ±nda normalize eder
            #0 Ã¼st kenarÄ±, 1 alt kenarÄ± temsil eder.
            map_y = center_y / frame_height  # 0=Ã¼st, 1=alt (kameradan bakÄ±ÅŸ)
            # drone merkezinin y koordinatÄ±nÄ±, Ã§erÃ§eve yÃ¼ksekliÄŸine oranlayarak 0-1 arasÄ±nda normalze eder
            #0 Ã¼st kenarÄ±, 1 alt kenarÄ± temsil eder
            
            # Client iÃ§in display koordinatlarÄ± (client'ta gÃ¶sterilecek)
            # Client update_map() ve update_table() fonksiyonlarÄ± bu dÃ¶nÃ¼ÅŸÃ¼mÃ¼ yapar
            display_x = -((map_x * 2) - 1)  # [-1,1] arasÄ±, client haritasÄ± iÃ§in
            # map_x (0-1) deÄŸerini alÄ±p (-1,1) arasÄ±nda Ã¶lÃ§ekler ve iÅŸareti tersine Ã§evirir
            display_y = -((map_y * 2) - 1)  # [-1,1] arasÄ±, client haritasÄ± iÃ§in
            
            # BÃ¶lge adÄ±nÄ± client koordinat sistemine gÃ¶re hesapla
            zone_name = get_direction_from_coordinates(display_x, display_y)
            # normalize edilmiÅŸ display_x ve display_y deÄŸerlerini kullanarak drone nun hangi bÃ¶lgede olduÄŸunu belirler
            
            # Client ile uyumlu tehlike seviyesi belirleme
            current_threat = "YOK"
            distance_info = "Uzak"
            
            if area > 40000:
                current_threat = "YUKSEK TEHLÄ°KE"
                distance_info = "Ã‡ok YakÄ±n"
                alert_triggered = True
            elif area > 20000:
                current_threat = "ORTA SEVÄ°YE"
                distance_info = "YakÄ±n"
            elif area > 5000:
                current_threat = "DUSUK"
                distance_info = "Orta"
            else:
                current_threat = "DUSUK"
                distance_info = "Uzak"
            
            # Genel tehlike seviyesini gÃ¼ncelle (en yÃ¼ksek olanÄ± al)
            if current_threat == "YUKSEK TEHLÄ°KE":
                threat_level = "YUKSEK TEHLÄ°KE"
            elif current_threat == "ORTA SEVÄ°YE" and threat_level != "YUKSEK TEHLÄ°KE":
                threat_level = "ORTA SEVÄ°YE"
            elif current_threat == "DUSUK" and threat_level == "YOK":
                threat_level = "DUSUK"

            # YÃ¼kseklik ve mesafe hesaplama
            distance_meters = f"{int(400 - (area/200))}m" if area < 60000 else f"{int(50 + (60000-area)/1000)}m"
            altitude = f"{int(80 - (area/1000))}m" if area < 40000 else f"{int(20 + (area-20000)/2000)}m"

            # Client formatÄ±na TAMAMEN uygun drone verisi
            drone_info = { # drone_info, mevcut karedeki her bir drone tespiti iÃ§in Client'a gÃ¶nderilecek veya anlÄ±k tabloda kullanÄ±lacak detaylÄ± bir sÃ¶zlÃ¼ktÃ¼r. TÃ¼m hesaplanan bilgileri iÃ§erir.
                "id": j + 1,
                "confidence": round(confidence, 1),
                "position": {
                    "zone": zone_name,
                    "distance": distance_info,
                    "distance_meters": distance_meters,
                    "altitude": altitude,
                    "gps": {
                        "latitude": round(drone_lat, 6),
                        "longitude": round(drone_lon, 6),
                        "altitude_m": int(altitude.replace('m', ''))
                    },
                    # BU KRÄ°TÄ°K: Client'Ä±n beklediÄŸi ham koordinatlar
                    "map_x": map_x,  # 0-1 arasÄ±, kamera perspektifi
                    "map_y": map_y   # 0-1 arasÄ±, kamera perspektifi
                }
            }
            detections.append(drone_info)
            
            # GeÃ§miÅŸe ekle - Client formatÄ±na TAMAMEN uygun
            history_entry = {
                "timestamp": datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                "id": f"D{j+1}",
                "confidence": round(confidence, 1),
                "zone": zone_name,
                "threat_level": current_threat,
                # GeÃ§miÅŸ iÃ§in display koordinatlarÄ± (client gÃ¶sterimi ile aynÄ±)
                "x_coord": display_x,
                "y_coord": display_y
            }
            
            detection_history.append(history_entry)
            if len(detection_history) > max_history:
                detection_history.pop(0)

    # Global verileri gÃ¼ncelle - Client formatÄ±
    current_drone_data = {
        "drone_count": len(detections),
        "threat_level": threat_level,
        "detections": detections,
        "timestamp": datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        "fire_authorized": threat_level == "YUKSEK TEHLÄ°KE"
    }

    if alert_triggered:
        play_alert()

    # Verileri istemcilere gÃ¶nder
    broadcast_drone_data() # bu fonk ile current_drone_data iÃ§indei bilgiler client kÄ±smÄ±na iletilir.

def update_gui():
    """GUI'yi gÃ¼ncelle"""
    # Sistem durumu gÃ¼ncelle
    client_count_label.config(text=f"BaÄŸlÄ± Ä°stemci: {len(connected_clients)}")
    system_time_label.config(text=f"Sistem Saati: {datetime.now().strftime('%H:%M:%S')}")
    
    # Tehlike seviyesi gÃ¼ncelle - Client ile uyumlu renkler
    threat_level = current_drone_data.get("threat_level", "YOK")
    threat_level_label.config(text=f"Tehlike Seviyesi: {threat_level}")
    
    # Client ile aynÄ± renk kodlarÄ±
    if threat_level == "YUKSEK TEHLÄ°KE":
        threat_level_label.config(fg="#ff0000")  # KÄ±rmÄ±zÄ±
    elif threat_level == "ORTA SEVÄ°YE":
        threat_level_label.config(fg="#ff8800")  # Turuncu
    elif threat_level == "DUSUK":
        threat_level_label.config(fg="#00ff00")  # YeÅŸil
    else:  # YOK
        threat_level_label.config(fg="#00ff00")  # YeÅŸil
    
    active_drones_label.config(text=f"Aktif Drone: {current_drone_data.get('drone_count', 0)}")
    
    if current_drone_data.get("timestamp") and current_drone_data.get("drone_count" , 0) > 0:
        last_detection_label.config(text=f"Son Tespit: {current_drone_data['timestamp']}")
    elif current_drone_data.get("drone_count" , 0) == 0:
        # Drone yoksa "tespit yok" mesajÄ± gÃ¶ster, eski zamanÄ± koru
        if "Son Tespit:" not in last_detection_label.cget("text") or "tespit yok" in last_detection_label.cget("text"):
            last_detection_label.config(text="Son Tespit: Tespit yok")     
    
    # TablolarÄ± gÃ¼ncelle
    update_current_tree()
    update_history_tree()
    update_statistics()
    
    # Arka plan tespiti yap
    background_detection()
    
    # 100ms sonra tekrar Ã§aÄŸÄ±r
    window.after(100, update_gui)

# Sunucuyu baÅŸlat
start_server()

# GUI gÃ¼ncellemesini baÅŸlat
update_gui()

# Pencere kapatÄ±lÄ±rken temizlik
def on_closing():
    """Uygulama kapatÄ±lÄ±rken temizlik iÅŸlemleri"""
    global connected_clients
    
    # KamerayÄ± kapat
    if cap.isOpened():
        cap.release()
    
    # OpenCV pencerelerini kapat
    cv2.destroyAllWindows()
    
    # Pygame'i kapat
    pygame.quit()
    
    # TÃ¼m client baÄŸlantÄ±larÄ±nÄ± kapat
    for client in connected_clients[:]:
        try: 
            client.close()
        except:
            pass
    connected_clients.clear()
    
    # Tkinter penceresini kapat
    window.quit()
    window.destroy()

# Pencere kapatma protokolÃ¼nÃ¼ ayarla
window.protocol("WM_DELETE_WINDOW", on_closing)

# Ana dÃ¶ngÃ¼yÃ¼ baÅŸlat
try:
    window.mainloop()
except KeyboardInterrupt:
    print("\nâœ‹ Program kullanÄ±cÄ± tarafÄ±ndan durduruldu")
    on_closing()
except Exception as e:
    print(f"âŒ Beklenmeyen hata: {e}")
    on_closing()
finally:
    print("ğŸ‘‹ Server programÄ± sonlandÄ±rÄ±ldÄ±")
