import socket
import tkinter as tk
from tkinter import ttk, messagebox, Canvas
import json
import threading
from datetime import datetime
import collections
import os

class DroneDetectionClient:
    def __init__(self):
        # Default IP and Port values
        self.default_server_host = '127.0.0.1'
        self.default_server_port = 8888

        self.socket = None
        self.connected = False
        self.running = True
        
        # KullanÄ±cÄ± verilerini JSON'dan yÃ¼kle
        self.users = self.load_users_from_json()
        
        # Login credentials
        self.login_attempts = 0
        self.max_attempts = 3
        self.logged_in = False
        self.current_user = None
        
        # Drone verileri iÃ§in gÃ¼ncel durum
        self.current_data = {
            "drone_count": 0,
            "threat_level": "YOK",
            "detections": [],
            "timestamp": "",
            "fire_authorized": False
        }
        
        # GeÃ§miÅŸ tespitler iÃ§in deque
        self.detection_history = collections.deque(maxlen=1000)
        
        self.setup_login_ui()
        
    def load_users_from_json(self):
        """JSON dosyasÄ±ndan kullanÄ±cÄ± bilgilerini yÃ¼kler"""
        json_path = r"C:\Users\yaren\OneDrive\MasaÃ¼stÃ¼\drone_dataset\kullanici_bilgileri.json"
        users = {}
        
        try:
            with open(json_path, 'r', encoding='utf-8') as f:
                user_list = json.load(f)
                
            for user in user_list:
                username = user.get("kullanici_adi")
                password = user.get("kullanici_sifre")
                role = user.get("kullanici_yetkisi")
                
                if username and password:
                    users[username] = {
                        "password": password,
                        "name": username,
                        "role": role
                    }
            
            print(f"{len(users)} kullanÄ±cÄ± baÅŸarÄ±yla yÃ¼klendi")
            return users
            
        except FileNotFoundError:
            print(f"Hata: {json_path} dosyasÄ± bulunamadÄ±")
            return {}
        except json.JSONDecodeError:
            print(f"Hata: {json_path} geÃ§ersiz JSON formatÄ±")
            return {}
        except Exception as e:
            print(f"Beklenmeyen hata: {str(e)}")
            return {}
    
    def setup_login_ui(self):
        """GiriÅŸ ekranÄ± arayÃ¼zÃ¼nÃ¼ kurar"""
        self.window = tk.Tk()
        self.window.title("Drone Tespit Sistemi - GiriÅŸ")
        self.window.geometry("500x400")
        self.window.configure(bg="#1a1a1a")

        # Pencereyi ortala
        self.window.geometry("+{}+{}".format(
            (self.window.winfo_screenwidth() // 2) - 250,
            (self.window.winfo_screenheight() // 2) - 200
        ))
        
        # Login frame
        self.login_frame = tk.Frame(self.window, bg="#1a1a1a")
        self.login_frame.pack(fill=tk.BOTH, expand=True)
        
        # BaÅŸlÄ±k
        title_label = tk.Label(self.login_frame,
                              text="ğŸ›¡ï¸ DRONE TESPÄ°T SÄ°STEMÄ°",
                              font=("Arial", 20, "bold"),
                              bg="#1a1a1a", fg="#00ff00")
        title_label.pack(pady=30)
        
        subtitle_label = tk.Label(self.login_frame,
                                 text="SÄ°STEM GÄ°RÄ°ÅÄ°",
                                 font=("Arial", 14, "bold"),
                                 bg="#1a1a1a", fg="#ffffff")
        subtitle_label.pack(pady=10)
        
        # Login container
        login_container = tk.Frame(self.login_frame, bg="#2c2c2c", relief=tk.RAISED, bd=2)
        login_container.pack(pady=20, padx=50, fill=tk.X)
        
        # KullanÄ±cÄ± adÄ±
        username_label = tk.Label(login_container,
                                 text="KullanÄ±cÄ± AdÄ±:",
                                 font=("Arial", 12, "bold"),
                                 bg="#2c2c2c", fg="#ffffff")
        username_label.pack(pady=(20, 5))
        
        self.username_entry = tk.Entry(login_container,
                                      font=("Arial", 12),
                                      bg="#3a3a3a", fg="#ffffff",
                                      insertbackground="#ffffff",
                                      justify=tk.CENTER,
                                      width=20)
        self.username_entry.pack(pady=5)
        
        # Åifre
        password_label = tk.Label(login_container,
                                 text="Åifre:",
                                 font=("Arial", 12, "bold"),
                                 bg="#2c2c2c", fg="#ffffff")
        password_label.pack(pady=(15, 5))
        
        self.password_entry = tk.Entry(login_container,
                                      font=("Arial", 12),
                                      bg="#3a3a3a", fg="#ffffff",
                                      insertbackground="#ffffff",
                                      justify=tk.CENTER,
                                      width=20,
                                      show="*")
        self.password_entry.pack(pady=5)
        
        # GiriÅŸ butonu
        self.login_button = tk.Button(login_container,
                                     text="ğŸ” GÄ°RÄ°Å YAP",
                                     font=("Arial", 12, "bold"),
                                     bg="#008000", fg="#ffffff",
                                     command=self.attempt_login,
                                     width=15,
                                     height=2)
        self.login_button.pack(pady=20)
        
        # Durum etiketi
        self.login_status = tk.Label(login_container,
                                    text="",
                                    font=("Arial", 10),
                                    bg="#2c2c2c", fg="#ffff00")
        self.login_status.pack(pady=5)
        
        # Deneme sayacÄ±
        self.attempt_label = tk.Label(login_container,
                                     text=f"Kalan deneme hakkÄ±: {self.max_attempts - self.login_attempts}",
                                     font=("Arial", 9),
                                     bg="#2c2c2c", fg="#cccccc")
        self.attempt_label.pack(pady=(5, 20))
        
        # Enter tuÅŸu ile giriÅŸ
        self.username_entry.bind('<Return>', lambda event: self.attempt_login())
        self.password_entry.bind('<Return>', lambda event: self.attempt_login())
        
        # Ä°mleci kullanÄ±cÄ± adÄ± alanÄ±na focus et
        self.username_entry.focus()
        
        # Pencere kapatma protokolÃ¼
        self.window.protocol("WM_DELETE_WINDOW", self.on_closing)
    
    def attempt_login(self):
        """GiriÅŸ denemesi yapar"""
        username = self.username_entry.get().strip()
        password = self.password_entry.get().strip()
        
        if not username or not password:
            self.login_status.config(text="âŒ KullanÄ±cÄ± adÄ± ve ÅŸifre gerekli!", fg="#ff0000")
            return
        
        # JSON'dan yÃ¼klenen kullanÄ±cÄ±larla kontrol et
        if username in self.users and self.users[username]["password"] == password:
            # BaÅŸarÄ±lÄ± giriÅŸ
            self.logged_in = True
            self.current_user = {
                "username": username,
                "name": self.users[username]["name"],
                "role": self.users[username]["role"]
            }
            self.login_status.config(text="âœ… GiriÅŸ baÅŸarÄ±lÄ±! Sistem aÃ§Ä±lÄ±yor...", fg="#00ff00")
            self.window.after(1000, self.show_main_system)
        else:
            # BaÅŸarÄ±sÄ±z giriÅŸ
            self.login_attempts += 1
            remaining_attempts = self.max_attempts - self.login_attempts
            
            if remaining_attempts > 0:
                self.login_status.config(text=f"âŒ HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!", fg="#ff0000")
                self.attempt_label.config(text=f"Kalan deneme hakkÄ±: {remaining_attempts}")
                self.password_entry.delete(0, tk.END)
                self.password_entry.focus()
            else:
                self.login_status.config(text="ğŸš« Maksimum deneme sayÄ±sÄ±na ulaÅŸÄ±ldÄ±!", fg="#ff0000")
                self.attempt_label.config(text="Sistem kapatÄ±lÄ±yor...", fg="#ff0000")
                self.login_button.config(state=tk.DISABLED, bg="#666666")
                self.username_entry.config(state=tk.DISABLED)
                self.password_entry.config(state=tk.DISABLED)
                self.window.after(2000, self.on_closing)
    
    def show_main_system(self):
        """Ana sistem ekranÄ±nÄ± gÃ¶sterir"""
        self.login_frame.destroy()
        
        # Pencereyi yeniden boyutlandÄ±r ve ortala
        self.window.title("Drone Tespit Sistemi")
        self.window.geometry("1400x800")
        self.window.geometry("+{}+{}".format(
            (self.window.winfo_screenwidth() // 2) - 700,
            (self.window.winfo_screenheight() // 2) - 400
        ))
        
        self.setup_main_ui()
        
    def setup_main_ui(self):
        """Ana sistem arayÃ¼zÃ¼nÃ¼ kurar"""
        # Ana container
        main_container = tk.Frame(self.window, bg="#1a1a1a")
        main_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        # --- Ãœst Navigasyon ve BaÅŸlÄ±k Frame ---
        header_frame = tk.Frame(main_container, bg="#1a1a1a")
        header_frame.pack(fill=tk.X, pady=(0, 10))

        title_label = tk.Label(header_frame, 
                               text="ğŸ›¡ï¸ DRONE TESPÄ°T SÄ°STEMÄ°",
                               font=("Arial", 18, "bold"),
                               bg="#1a1a1a", fg="#00ff00")
        title_label.pack(side=tk.LEFT, padx=10)

        # KullanÄ±cÄ± bilgileri ve Ã§Ä±kÄ±ÅŸ
        user_info_frame = tk.Frame(header_frame, bg="#1a1a1a")
        user_info_frame.pack(side=tk.RIGHT, padx=10)
        
        user_label = tk.Label(user_info_frame,
                             text=f"ğŸ‘¤ KullanÄ±cÄ±: {self.current_user['name']} ({self.current_user['username']})",
                             font=("Arial", 10),
                             bg="#1a1a1a", fg="#ffffff")
        user_label.pack(side=tk.LEFT, padx=(0, 10))
        
        logout_button = tk.Button(user_info_frame,
                                 text="ğŸšª Ã‡Ä±kÄ±ÅŸ",
                                 font=("Arial", 10, "bold"),
                                 bg="#cc0000", fg="#ffffff",
                                 command=self.logout)
        logout_button.pack(side=tk.LEFT)

        # Navigasyon butonlarÄ±
        nav_button_frame = tk.Frame(header_frame, bg="#1a1a1a")
        nav_button_frame.pack(side=tk.RIGHT, padx=(0, 150))

        self.home_button = tk.Button(nav_button_frame,
                                     text="ğŸ  Ana Ekran",
                                     font=("Arial", 10, "bold"),
                                     bg="#0066cc", fg="#ffffff",
                                     command=lambda: self.show_frame(self.main_detection_frame))
        self.home_button.pack(side=tk.LEFT, padx=5)

        self.reports_button = tk.Button(nav_button_frame,
                                        text="ğŸ“‹ Raporlar",
                                        font=("Arial", 10, "bold"),
                                        bg="#0066cc", fg="#ffffff",
                                        command=lambda: self.show_frame(self.reports_frame))
        self.reports_button.pack(side=tk.LEFT, padx=5)

        # Ana tespit ekranÄ± frame
        self.main_detection_frame = tk.Frame(main_container, bg="#1a1a1a")
        self.main_detection_frame.pack(fill=tk.BOTH, expand=True)

        # Raporlar ekranÄ± frame (baÅŸlangÄ±Ã§ta gizli)
        self.reports_frame = tk.Frame(main_container, bg="#1a1a1a")
        
        # --- Sol Panel (BaÄŸlantÄ±, Harita, Kontrol) ---
        left_panel = tk.Frame(self.main_detection_frame, bg="#2c2c2c", relief=tk.RAISED, bd=2)
        left_panel.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 5))
        
        # --- SaÄŸ Panel (Drone DetaylarÄ±, Tablo) ---
        right_panel = tk.Frame(self.main_detection_frame, bg="#2c2c2c", relief=tk.RAISED, bd=2, width=500)
        right_panel.pack(side=tk.RIGHT, fill=tk.BOTH, padx=(5, 0))
        right_panel.pack_propagate(False)
        
        # --- BaÄŸlantÄ± AyarlarÄ± Frame ---
        connection_frame = tk.LabelFrame(left_panel, 
                                         text="ğŸ“¡ BaÄŸlantÄ± AyarlarÄ±",
                                         font=("Arial", 10, "bold"),
                                         bg="#2c2c2c", fg="#ffffff")
        connection_frame.pack(fill=tk.X, padx=10, pady=5)
        
        # IP GiriÅŸ AlanÄ±
        ip_label = tk.Label(connection_frame, text="Sunucu IP:", bg="#2c2c2c", fg="#ffffff", font=("Arial", 10))
        ip_label.pack(side=tk.LEFT, padx=(5, 2), pady=5)
        self.ip_entry = tk.Entry(connection_frame, width=15, font=("Arial", 10), bg="#3a3a3a", fg="#ffffff", insertbackground="#ffffff")
        self.ip_entry.insert(0, self.default_server_host)
        self.ip_entry.pack(side=tk.LEFT, padx=(0, 10), pady=5)

        # Port GiriÅŸ AlanÄ±
        port_label = tk.Label(connection_frame, text="Port:", bg="#2c2c2c", fg="#ffffff", font=("Arial", 10))
        port_label.pack(side=tk.LEFT, padx=(5, 2), pady=5)
        self.port_entry = tk.Entry(connection_frame, width=7, font=("Arial", 10), bg="#3a3a3a", fg="#ffffff", insertbackground="#ffffff")
        self.port_entry.insert(0, str(self.default_server_port))
        self.port_entry.pack(side=tk.LEFT, padx=(0, 10), pady=5)

        # BaÄŸlan Butonu
        self.connect_button_ui = tk.Button(connection_frame,
                                           text="BaÄŸlan",
                                           font=("Arial", 10, "bold"),
                                           bg="#008000", fg="#ffffff",
                                           command=self.initiate_connection_from_ui)
        self.connect_button_ui.pack(side=tk.LEFT, padx=(0, 5), pady=5)

        # BaÄŸlantÄ± Durum Etiketi
        self.connection_status = tk.Label(connection_frame,
                                         text="ğŸ”„ BaÄŸlantÄ± Bekleniyor...",
                                         font=("Arial", 10),
                                         bg="#2c2c2c", fg="#ffff00")
        self.connection_status.pack(side=tk.LEFT, padx=5)
        
        # Sunucu Bilgi Etiketi
        self.server_info = tk.Label(connection_frame,
                                   text=f"Hedef: {self.default_server_host}:{self.default_server_port}",
                                   font=("Arial", 9),
                                   bg="#2c2c2c", fg="#cccccc")
        self.server_info.pack(side=tk.RIGHT, padx=5)
        
        # --- Harita GÃ¶rÃ¼nÃ¼mÃ¼ Frame ---
        map_frame = tk.LabelFrame(left_panel,
                                 text="ğŸ—ºï¸ Harita GÃ¶rÃ¼nÃ¼mÃ¼",
                                 font=("Arial", 12, "bold"),
                                 bg="#2c2c2c", fg="#ffffff")
        map_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
        
        self.map_canvas = Canvas(map_frame, bg="#0d4f3c", width=600, height=400)
        self.map_canvas.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)

        # --- Kontrol Paneli Frame ---
        control_frame = tk.LabelFrame(left_panel,
                                     text="ğŸ¯ Kontrol Paneli",
                                     font=("Arial", 12, "bold"),
                                     bg="#2c2c2c", fg="#ffffff")
        control_frame.pack(fill=tk.X, padx=10, pady=5)
        
        status_row = tk.Frame(control_frame, bg="#2c2c2c")
        status_row.pack(fill=tk.X, padx=5, pady=5)
        
        self.threat_level_label = tk.Label(status_row,
                                         text="TEHLÄ°KE: YOK",
                                         font=("Arial", 14, "bold"),
                                         bg="#2c2c2c", fg="#00ff00")
        self.threat_level_label.pack(side=tk.LEFT)
        
        self.drone_count_label = tk.Label(status_row,
                                         text="Drone: 0",
                                         font=("Arial", 12),
                                         bg="#2c2c2c", fg="#ffffff")
        self.drone_count_label.pack(side=tk.RIGHT)
        
        button_row = tk.Frame(control_frame, bg="#2c2c2c")
        button_row.pack(fill=tk.X, padx=5, pady=5)
        
        # AteÅŸ etme butonu - role gÃ¶re kontrol
        fire_enabled = self.current_user["role"] in ["admin", "yonetici", "operator"]
        self.fire_button = tk.Button(button_row,
                                     text="ğŸ¯ ATEÅ ET",
                                     font=("Arial", 14, "bold"),
                                     bg="#666666" if not fire_enabled else "#ff0000",
                                     fg="#ffffff",
                                     state=tk.DISABLED if not fire_enabled else tk.NORMAL,
                                     command=self.fire_command,
                                     height=2,
                                     relief=tk.RAISED)
        self.fire_button.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 5))
        
        self.reconnect_button = tk.Button(button_row,
                                         text="ğŸ”„ Yeniden BaÄŸlan",
                                         font=("Arial", 10),
                                         bg="#0066cc",
                                         fg="#ffffff",
                                         command=self.reconnect)
        self.reconnect_button.pack(side=tk.RIGHT)
        
        # --- Drone DetaylarÄ± BaÅŸlÄ±k ---
        details_title = tk.Label(right_panel,
                               text="ğŸ“Š DRONE DETAYLARI",
                               font=("Arial", 14, "bold"),
                               bg="#2c2c2c", fg="#ffffff")
        details_title.pack(pady=10)
        
        # --- Tespit Tablosu Frame ---
        table_frame = tk.LabelFrame(right_panel,
                                   text="ğŸ“‹ Tespit Tablosu",
                                   font=("Arial", 10, "bold"),
                                   bg="#2c2c2c", fg="#ffffff")
        table_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
        
        # Treeview stil ayarlarÄ±
        style = ttk.Style()
        style.theme_use('clam')
        style.configure("GPS.Treeview",
                        background="#1a1a1a",
                        foreground="#ffffff",
                        rowheight=25,
                        fieldbackground="#1a1a1a")
        style.configure("GPS.Treeview.Heading",
                        background="#0066cc",
                        foreground="#ffffff",
                        font=("Arial", 9, "bold"))
        
        # Treeview sÃ¼tunlarÄ±
        columns = ("ID", "Tehlike Seviyesi", "GÃ¼ven", "BÃ¶lge", "X Ekseni", "Y Ekseni")
        self.drone_tree = ttk.Treeview(table_frame, 
                                       columns=columns, 
                                       show="headings",
                                       style="GPS.Treeview",
                                       height=8)
        
        # SÃ¼tun baÅŸlÄ±klarÄ± ve geniÅŸlikleri
        widths = [40, 120, 60, 80, 70, 70]
        for i, col in enumerate(columns):
            self.drone_tree.heading(col, text=col)
            self.drone_tree.column(col, width=widths[i], anchor=tk.CENTER)
        
        # KaydÄ±rma Ã§ubuÄŸu
        tree_scroll = ttk.Scrollbar(table_frame, orient=tk.VERTICAL, command=self.drone_tree.yview)
        self.drone_tree.configure(yscrollcommand=tree_scroll.set)
        
        self.drone_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        tree_scroll.pack(side=tk.RIGHT, fill=tk.Y)
        
        # Son GÃ¼ncelleme Etiketi
        self.timestamp_label = tk.Label(right_panel,
                                         text="Son GÃ¼ncelleme: --",
                                         font=("Arial", 9),
                                         bg="#2c2c2c", fg="#cccccc")
        self.timestamp_label.pack(pady=5)
        
        # --- Raporlar EkranÄ± Kurulumu ---
        self.setup_reports_ui()

        # Harita tabanÄ±nÄ± Ã§izmek iÃ§in gecikmeli Ã§aÄŸrÄ±
        self.window.after(500, self.draw_map_base)

        # BaÅŸlangÄ±Ã§ta Ana EkranÄ± GÃ¶ster
        self.show_frame(self.main_detection_frame)
    
    def setup_reports_ui(self):
        """Raporlar ekranÄ± arayÃ¼zÃ¼nÃ¼ kurar"""
        self.reports_frame.config(bg="#1a1a1a")
        
        reports_title = tk.Label(self.reports_frame,
                                 text="ğŸ“Š DRONE TESPÄ°T RAPORLARI",
                                 font=("Arial", 18, "bold"),
                                 bg="#1a1a1a", fg="#00ff00")
        reports_title.pack(pady=20)

        reports_table_frame = tk.LabelFrame(self.reports_frame,
                                            text="ğŸ“‹ Tespit GeÃ§miÅŸi Tablosu",
                                            font=("Arial", 12, "bold"),
                                            bg="#2c2c2c", fg="#ffffff")
        reports_table_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

        # Raporlar tablosu sÃ¼tunlarÄ±
        report_columns = ("Tespit Saati", "ID", "GÃ¼ven", "BÃ¶lge", "Tehlike Seviyesi", "X Ekseni", "Y Ekseni")
        self.reports_tree = ttk.Treeview(reports_table_frame,
                                         columns=report_columns,
                                         show="headings",
                                         style="GPS.Treeview")

        report_widths = [180, 60, 80, 120, 120, 70, 70]
        for i, col in enumerate(report_columns):
            self.reports_tree.heading(col, text=col)
            self.reports_tree.column(col, width=report_widths[i], anchor=tk.CENTER)

        report_tree_scroll_y = ttk.Scrollbar(reports_table_frame, orient=tk.VERTICAL, command=self.reports_tree.yview)
        report_tree_scroll_x = ttk.Scrollbar(reports_table_frame, orient=tk.HORIZONTAL, command=self.reports_tree.xview)
        self.reports_tree.configure(yscrollcommand=report_tree_scroll_y.set, xscrollcommand=report_tree_scroll_x.set)

        self.reports_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        report_tree_scroll_y.pack(side=tk.RIGHT, fill=tk.Y)
        report_tree_scroll_x.pack(side=tk.BOTTOM, fill=tk.X)

    def show_frame(self, frame):
        """Belirtilen frame'i gÃ¶sterir ve diÄŸerlerini gizler"""
        self.main_detection_frame.pack_forget()
        self.reports_frame.pack_forget()
        
        frame.pack(fill=tk.BOTH, expand=True)
        
        # Raporlar ekranÄ±na geÃ§iÅŸ yaparken tabloyu gÃ¼ncelle
        if frame == self.reports_frame:
            self.update_reports_table()

    def draw_map_base(self):
        """Harita canvas'Ä±nÄ±n taban Ä±zgarasÄ±nÄ± ve yÃ¶n gÃ¶stergelerini Ã§izer"""
        self.map_canvas.delete("all")
        width = self.map_canvas.winfo_width()
        height = self.map_canvas.winfo_height()
        
        # Canvas boyutlarÄ± henÃ¼z belirlenmediyse yeniden dene
        if width <= 1 or height <= 1:
            self.window.after(500, self.draw_map_base)
            return
        
        # Koordinat sistemi iÃ§in merkez hesapla
        center_x, center_y = width // 2, height // 2
        
        # Koordinat sistemi iÃ§in Ä±zgara Ã§izgileri (-1.0 to 1.0)
        # X ekseni Ã§izgileri (dikey) - BATI(-1.0) sol, DOÄU(+1.0) saÄŸ
        for i in range(-10, 11):
            x_coord = center_x + (i * 0.1) * (width / 2)
            self.map_canvas.create_line(x_coord, 0, x_coord, height, fill="#0a3d2e", width=1)
            # X ekseni etiketleri
            if i % 2 == 0:
                label_x = x_coord
                label_y = center_y + 15
                self.map_canvas.create_text(label_x, label_y, text=f"{i * 0.1:.1f}", fill="#ffffff", font=("Arial", 7))

        # Y ekseni Ã§izgileri (yatay) - GÃœNEY(-1.0) alt, KUZEY(+1.0) Ã¼st
        for i in range(-10, 11):
            y_coord = center_y - (i * 0.1) * (height / 2)
            self.map_canvas.create_line(0, y_coord, width, y_coord, fill="#0a3d2e", width=1)
            # Y ekseni etiketleri
            if i % 2 == 0:
                label_x = center_x - 20
                label_y = y_coord
                self.map_canvas.create_text(label_x, label_y, text=f"{i * 0.1:.1f}", fill="#ffffff", font=("Arial", 7))
        
        # Merkez Ã§izgiler (X ve Y eksenleri)
        self.map_canvas.create_line(center_x, 0, center_x, height, fill="#1a5c42", width=2)
        self.map_canvas.create_line(0, center_y, width, center_y, fill="#1a5c42", width=2)
        
        # Ana yÃ¶n gÃ¶stergeleri
        self.map_canvas.create_text(center_x, 15, text="KUZEY â†‘ (+Y)", fill="#ffffff", font=("Arial", 10, "bold"))
        self.map_canvas.create_text(center_x, height-15, text="GÃœNEY â†“ (-Y)", fill="#ffffff", font=("Arial", 10, "bold"))
        self.map_canvas.create_text(20, center_y, text="BATI â† (-X)", fill="#ffffff", font=("Arial", 10, "bold"), angle=90)
        self.map_canvas.create_text(width-20, center_y, text="DOÄU â†’ (+X)", fill="#ffffff", font=("Arial", 10, "bold"), angle=90)
        
        # Ara yÃ¶n gÃ¶stergeleri
        offset = 30
        self.map_canvas.create_text(offset, offset, text="KUZEYBATI â†– (-X,+Y)", fill="#ffffff", font=("Arial", 8, "bold"), anchor="nw")
        self.map_canvas.create_text(width - offset, offset, text="KUZEYDOÄU â†— (+X,+Y)", fill="#ffffff", font=("Arial", 8, "bold"), anchor="ne")
        self.map_canvas.create_text(offset, height - offset, text="GÃœNEYBATI â†™ (-X,-Y)", fill="#ffffff", font=("Arial", 8, "bold"), anchor="sw")
        self.map_canvas.create_text(width - offset, height - offset, text="GÃœNEYDOÄU â†˜ (+X,-Y)", fill="#ffffff", font=("Arial", 8, "bold"), anchor="se")

        # Merkez nokta (0,0)
        self.map_canvas.create_oval(center_x-5, center_y-5, center_x+5, center_y+5, 
                                     fill="#ffff00", outline="#000000", width=2, tags="center")
        self.map_canvas.create_text(center_x+15, center_y-15, text="(0,0)", fill="#ffff00", font=("Arial", 9, "bold"))
    
    def update_map(self):
        """Harita canvas'Ä±nda drone pozisyonlarÄ±nÄ± gÃ¼nceller"""
        self.map_canvas.delete("drone")
        
        width = self.map_canvas.winfo_width()
        height = self.map_canvas.winfo_height()
        center_x, center_y = width//2, height//2
        
        for detection in self.current_data.get("detections", []):
            pos = detection.get("position", {})
            
            # Server ile tam uyumlu koordinat sistemi
            raw_map_x = pos.get("map_x", 0.5)
            raw_map_y = pos.get("map_y", 0.5)
            
            # Server ile aynÄ± dÃ¶nÃ¼ÅŸÃ¼m algoritmasÄ±
            normalized_x = -((raw_map_x * 2) - 1)
            normalized_y = -((raw_map_y * 2) - 1)

            # Normalized koordinatlarÄ± canvas piksel koordinatlarÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
            map_x_pixel = center_x + (normalized_x * (width / 2))
            map_y_pixel = center_y - (normalized_y * (height / 2))
            
            drone_id = detection.get("id", "?")
            confidence = detection.get("confidence", 0)
            
            # Drone'u daire olarak Ã§iz
            self.map_canvas.create_oval(map_x_pixel-8, map_y_pixel-8, map_x_pixel+8, map_y_pixel+8,
                                         fill="#ff0000", outline="#ffffff", width=2, tags="drone")
            # Drone ID'sini yaz
            self.map_canvas.create_text(map_x_pixel, map_y_pixel, text=str(drone_id), 
                                         fill="#ffffff", font=("Arial", 8, "bold"), tags="drone")
            # Merkezden drone'a kesikli Ã§izgi Ã§iz
            self.map_canvas.create_line(center_x, center_y, map_x_pixel, map_y_pixel, 
                                         fill="#00ff00", width=1, dash=(5, 5), tags="drone")
            
            # Drone yakÄ±nÄ±na koordinat bilgisi ekle
            coord_text = f"({normalized_x:.2f},{normalized_y:.2f})"
            self.map_canvas.create_text(map_x_pixel, map_y_pixel+15, text=coord_text, 
                                         fill="#00ff00", font=("Arial", 7), tags="drone")

    def initiate_connection_from_ui(self):
        """UI giriÅŸ alanlarÄ±ndan IP ve Port alarak baÄŸlantÄ±yÄ± baÅŸlatÄ±r"""
        if not self.logged_in:
            self.show_message_box("EriÅŸim HatasÄ±", "Bu iÅŸlem iÃ§in giriÅŸ yapmanÄ±z gerekli!", "error")
            return
            
        host = self.ip_entry.get()
        port_str = self.port_entry.get()

        if not host:
            self.show_message_box("BaÄŸlantÄ± HatasÄ±", "LÃ¼tfen sunucu IP adresini girin.", "error")
            return

        try:
            port = int(port_str)
            if not (1 <= port <= 65535):
                raise ValueError("Port 1-65535 arasÄ±nda olmalÄ±dÄ±r.")
        except ValueError:
            self.show_message_box("BaÄŸlantÄ± HatasÄ±", "GeÃ§erli bir port numarasÄ± girin (Ã¶rn: 8888).", "error")
            return
        
        # Mevcut socket'i kapat (varsa)
        if self.socket:
            try:
                self.socket.close()
            except:
                pass
            self.connected = False
            self.socket = None

        self.connection_status.config(text="ğŸ”„ BaÄŸlanÄ±yor...", fg="#ffff00")
        self.server_info.config(text=f"Hedef: {host}:{port}")
        self.connect_to_server(host, port)

    def connect_to_server(self, host, port):
        """Belirtilen sunucuya baÄŸlanmayÄ± dener"""
        def connect_thread():
            try:
                self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                self.socket.settimeout(5.0)
                self.socket.connect((host, port))
                self.connected = True
                
                # KullanÄ±cÄ± giriÅŸ bilgisini gÃ¶nder
                if self.logged_in and self.current_user:
                    login_info = {
                        "type": "login",
                        "username": self.current_user["username"],
                        "password": self.users[self.current_user["username"]]["password"],
                        "name": self.current_user["name"],
                        "timestamp": datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]
                    }
                    self.socket.send((json.dumps(login_info) + "\n").encode('utf-8'))
                
                self.window.after(0, lambda: self.connection_status.config(
                    text="âœ… BaÄŸlandÄ±", fg="#00ff00"))
                self.window.after(0, lambda: self.server_info.config(
                    text=f"BaÄŸlÄ±: {host}:{port}"))
                
                # Sunucudan veri dinlemeyi baÅŸlat
                threading.Thread(target=self.listen_server, daemon=True).start()
            except Exception as e:
                self.connected = False
                self.window.after(0, lambda: self.connection_status.config(
                    text="âŒ BaÄŸlantÄ± HatasÄ±", fg="#ff0000"))
                self.window.after(0, lambda: self.server_info.config(
                    text=f"Hedef: {host}:{port} (BaÄŸlantÄ± HatasÄ±)"))
                print(f"BaÄŸlantÄ± hatasÄ±: {e}")
        
        threading.Thread(target=connect_thread, daemon=True).start()
        
    def listen_server(self):
        """Sunucudan gelen verileri dinler ve iÅŸler"""
        buffer = ""
        while self.connected and self.running:
            try:
                data = self.socket.recv(1024).decode('utf-8')
                if not data:
                    break
                buffer += data
                while '\n' in buffer:
                    line, buffer = buffer.split('\n', 1)
                    if line.strip():
                        try:
                            response = json.loads(line)
                            
                            # GiriÅŸ yanÄ±tÄ± kontrolÃ¼
                            if response.get("type") == "login_response":
                                if response.get("success"):
                                    print("Sunucu tarafÄ±ndan giriÅŸ doÄŸrulandÄ±")
                                else:
                                    self.show_message_box("GiriÅŸ HatasÄ±", response.get("message", "Sunucu tarafÄ±ndan giriÅŸ reddedildi"), "error")
                                    self.logout()
                            # AteÅŸ komutu yanÄ±tÄ±
                            elif response.get("type") == "fire_response":
                                self.window.after(0, lambda r=response: self.handle_fire_response(r))
                            else:
                                # Normal drone verisi
                                self.current_data = response
                                self.window.after(0, self.update_ui)
                                self.window.after(0, self.add_to_history)
                        except json.JSONDecodeError:
                            print(f"JSON AyrÄ±ÅŸtÄ±rma HatasÄ±: {line}")
                            pass
            except socket.timeout:
                continue
            except ConnectionResetError:
                print("Sunucu baÄŸlantÄ±yÄ± sÄ±fÄ±rladÄ±.")
                break
            except Exception as e:
                print(f"Veri alma hatasÄ±: {e}")
                break
                
        # BaÄŸlantÄ± kesildiÄŸinde durumu gÃ¼ncelle
        self.connected = False
        self.window.after(0, lambda: self.connection_status.config(
            text="âŒ BaÄŸlantÄ± Kesildi", fg="#ff0000"))
        self.window.after(0, lambda: self.server_info.config(
            text=f"BaÄŸlÄ± DeÄŸil"))
        
        # Uygulama hala Ã§alÄ±ÅŸÄ±yorsa otomatik yeniden baÄŸlanmayÄ± dene
        if self.running:
            threading.Timer(3.0, self.reconnect).start()
            
    def handle_fire_response(self, response):
        """Sunucudan gelen ateÅŸ komutu yanÄ±tÄ±nÄ± iÅŸler"""
        success = response.get("success", False)
        message = response.get("message", "")
        if success:
            self.show_message_box("AteÅŸ Etme Sonucu", f"âœ… {message}", "info")
        else:
            self.show_message_box("AteÅŸ Etme Sonucu", f"âŒ {message}", "error")
    
    def add_to_history(self):
        """Mevcut tespit verilerini geÃ§miÅŸe ekler"""
        timestamp = self.current_data.get("timestamp", "--")
        threat_level = self.current_data.get("threat_level", "YOK")

        for detection in self.current_data.get("detections", []):
            pos = detection.get("position", {})
            
            raw_map_x = pos.get("map_x", 0.5)
            raw_map_y = pos.get("map_y", 0.5)
            
            display_x = -((raw_map_x * 2) - 1)
            display_y = -((raw_map_y * 2) - 1)
            
            zone_name = pos.get("zone", self.get_direction_from_coordinates(display_x, display_y))
            
            history_entry = {
                "timestamp": timestamp,
                "id": detection.get("id", "-"),
                "confidence": detection.get("confidence", 0),
                "zone": zone_name,
                "threat_level": threat_level,
                "display_x": display_x,
                "display_y": display_y
            }
            self.detection_history.append(history_entry)

    def update_ui(self):
        """Gelen verilere gÃ¶re kullanÄ±cÄ± arayÃ¼zÃ¼nÃ¼ gÃ¼nceller"""
        if not self.logged_in:
            return
            
        data = self.current_data
        threat_colors = {
            "YOK": "#00ff00",
            "DUSUK": "#00ff00", 
            "ORTA SEVÄ°YE": "#ff8800",
            "YUKSEK TEHLÄ°KE": "#ff0000"
        }
        
        # Tehlike seviyesini ve rengini gÃ¼ncelle
        self.threat_level_label.config(
            text=f"TEHLÄ°KE: {data.get('threat_level', 'YOK')}",
            fg=threat_colors.get(data.get('threat_level', 'YOK'), "#ffffff")
        )
        # Drone sayÄ±sÄ±nÄ± gÃ¼ncelle
        self.drone_count_label.config(text=f"Drone: {data.get('drone_count', 0)}")
        # Zaman damgasÄ±nÄ± gÃ¼ncelle
        self.timestamp_label.config(text=f"Son GÃ¼ncelleme: {data.get('timestamp', '--')}")
        
        # "ATEÅ ET" buton durumunu gÃ¼ncelle
        if data.get("fire_authorized", False) and self.current_user["role"] in ["admin", "yonetici", "operator"]:
            self.fire_button.config(state=tk.NORMAL, bg="#ff0000")
        else:
            self.fire_button.config(state=tk.DISABLED, bg="#666666")
        
        self.update_table()
        self.update_map()
    
    def update_table(self):
        """Ana ekrandaki tespit tablosunu gÃ¼nceller"""
        for item in self.drone_tree.get_children():
            self.drone_tree.delete(item)
        
        current_threat_level = self.current_data.get("threat_level", "YOK")
        
        for detection in self.current_data.get("detections", []):
            pos = detection.get("position", {})
            
            raw_map_x = pos.get("map_x", 0.5)
            raw_map_y = pos.get("map_y", 0.5)
            
            display_x = -((raw_map_x * 2) - 1)
            display_y = -((raw_map_y * 2) - 1)

            direction = self.get_direction_from_coordinates(display_x, display_y)
            zone_name = pos.get("zone", direction)

            values = (
                f"D{detection.get('id', '-'):03d}",
                current_threat_level,
                f"{detection.get('confidence', 0):.1f}%",
                zone_name,
                f"{display_x:.2f}",
                f"{display_y:.2f}"
            )
            self.drone_tree.insert("", tk.END, values=values)

    def get_direction_from_coordinates(self, x, y):
        """Normalize edilmiÅŸ koordinatlara gÃ¶re yÃ¶n hesaplar (-1 to 1)"""
        tolerance = 0.1
        
        if abs(x) <= tolerance and abs(y) <= tolerance:
            return "MERKEZ"
        
        if abs(x) <= tolerance:
            return "KUZEY" if y > 0 else "GÃœNEY"
        elif abs(y) <= tolerance:
            return "DOÄU" if x > 0 else "BATI"
        else:
            if x > 0 and y > 0:
                return "KUZEYDOÄU"
            elif x < 0 and y > 0:
                return "KUZEYBATI"
            elif x < 0 and y < 0:
                return "GÃœNEYBATI"
            else:
                return "GÃœNEYDOÄU"

    def update_reports_table(self):
        """Raporlar ekranÄ±ndaki geÃ§miÅŸ tespit tablosunu gÃ¼nceller"""
        for item in self.reports_tree.get_children():
            self.reports_tree.delete(item)
        
        # GeÃ§miÅŸ kayÄ±tlarÄ± yeniden eskiden yeniye doÄŸru sÄ±rala
        sorted_history = sorted(self.detection_history, key=lambda x: x['timestamp'], reverse=True)

        for entry in sorted_history:
            display_x = entry.get("display_x", 0.0)
            display_y = entry.get("display_y", 0.0)

            values = (
                entry.get("timestamp", "--"),
                f"D{entry.get('id', '-')}",
                f"{entry.get('confidence', 0):.1f}%",
                entry.get("zone", self.get_direction_from_coordinates(display_x, display_y)),
                entry.get("threat_level", "YOK"),
                f"{display_x:.2f}",
                f"{display_y:.2f}"
            )
            self.reports_tree.insert("", tk.END, values=values)
    
    def fire_command(self):
        """'FIRE' komutunu sunucuya gÃ¶nderir ve yanÄ±tÄ± iÅŸler"""
        if not self.logged_in:
            self.show_message_box("EriÅŸim HatasÄ±", "Bu iÅŸlem iÃ§in giriÅŸ yapmanÄ±z gerekli!", "error")
            return
            
        if not self.connected:
            self.show_message_box("Hata", "Sunucuya baÄŸlÄ± deÄŸilsiniz!", "error")
            return
            
        # KullanÄ±cÄ±nÄ±n ateÅŸ etme yetkisi var mÄ± kontrol et
        if self.current_user["role"] not in ["admin", "yonetici", "operator"]:
            self.show_message_box("Yetki HatasÄ±", "AteÅŸ etme yetkiniz bulunmamaktadÄ±r!", "error")
            return
            
        try:
            command = {
                "command": "FIRE",
                "timestamp": datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3],
                "client_id": "gps_client_1",
                "user": self.current_user["username"]
            }
            self.socket.send((json.dumps(command) + "\n").encode('utf-8'))
        except Exception as e:
            self.show_message_box("Hata", f"Komut gÃ¶nderilemedi: {str(e)}", "error")
    
    def reconnect(self):
        """Mevcut IP/Port deÄŸerlerini kullanarak yeniden baÄŸlanmayÄ± dener"""
        if not self.logged_in:
            return
            
        if self.connected:
            try:
                self.socket.close()
            except:
                pass
            self.connected = False
            self.socket = None
            
        host = self.ip_entry.get()
        port_str = self.port_entry.get()

        if not host:
            self.show_message_box("BaÄŸlantÄ± HatasÄ±", "Yeniden baÄŸlanmak iÃ§in lÃ¼tfen sunucu IP adresini girin.", "error")
            self.connection_status.config(text="âŒ BaÄŸlantÄ± HatasÄ±", fg="#ff0000")
            return

        try:
            port = int(port_str)
            if not (1 <= port <= 65535):
                raise ValueError("Port 1-65535 arasÄ±nda olmalÄ±dÄ±r.")
        except ValueError:
            self.show_message_box("BaÄŸlantÄ± HatasÄ±", "Yeniden baÄŸlanmak iÃ§in geÃ§erli bir port numarasÄ± girin.", "error")
            self.connection_status.config(text="âŒ BaÄŸlantÄ± HatasÄ±", fg="#ff0000")
            return

        self.connection_status.config(text="ğŸ”„ Yeniden BaÄŸlanÄ±yor...", fg="#ffff00")
        self.server_info.config(text=f"Hedef: {host}:{port}")
        threading.Thread(target=self.connect_to_server, args=(host, port), daemon=True).start()
    
    def show_message_box(self, title, message, type="info"):
        """Ã–zel mesaj kutusu fonksiyonu"""
        if type == "info":
            messagebox.showinfo(title, message)
        elif type == "error":
            messagebox.showerror(title, message)
        elif type == "warning":
            messagebox.showwarning(title, message)

    def logout(self):
        """KullanÄ±cÄ±yÄ± Ã§Ä±kÄ±ÅŸ yapar ve giriÅŸ ekranÄ±na dÃ¶ner"""
        if messagebox.askyesno("Ã‡Ä±kÄ±ÅŸ", "Sistemden Ã§Ä±kmak istediÄŸinizden emin misiniz?"):
            # BaÄŸlantÄ±yÄ± kapat (varsa)
            if self.socket:
                try:
                    # Ã‡Ä±kÄ±ÅŸ bilgisini sunucuya gÃ¶nder
                    logout_info = {
                        "type": "logout",
                        "username": self.current_user["username"],
                        "timestamp": datetime.now().strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]
                    }
                    self.socket.send((json.dumps(logout_info) + "\n").encode('utf-8'))
                    self.socket.close()
                except:
                    pass
                self.connected = False
                self.socket = None
            
            # GiriÅŸ deÄŸiÅŸkenlerini sÄ±fÄ±rla
            self.logged_in = False
            self.login_attempts = 0
            self.current_user = None
            
            # Mevcut pencereyi kapat ve yeniden baÅŸlat
            self.window.destroy()
            self.__init__()
            self.run()
    
    def on_closing(self):
        """Pencere kapatÄ±ldÄ±ÄŸÄ±nda Ã§aÄŸrÄ±lÄ±r, baÄŸlantÄ± ve thread'leri temizler"""
        self.running = False
        self.connected = False
        
        if self.socket:
            try:
                self.socket.close()
            except:
                pass
        
        self.window.destroy()
    
    def run(self):
        """UygulamayÄ± Ã§alÄ±ÅŸtÄ±rÄ±r"""
        self.window.mainloop()

# Ana program
if __name__ == "__main__":
    client = DroneDetectionClient()
    client.run()
